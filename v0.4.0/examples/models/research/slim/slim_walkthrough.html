

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TF-Slim Walkthrough &mdash; NengoDL documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static\custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> NengoDL
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../frontend.html">User API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources.html">Additional resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../backend.html">Developer API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">NengoDL</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
      <li>TF-Slim Walkthrough</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/examples/models/research/slim/slim_walkthrough.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="TF-Slim-Walkthrough">
<h1>TF-Slim Walkthrough<a class="headerlink" href="#TF-Slim-Walkthrough" title="Permalink to this headline">¶</a></h1>
<p>This notebook will walk you through the basics of using TF-Slim to
define, train and evaluate neural networks on various tasks. It assumes
a basic knowledge of neural networks.</p>
<div class="section" id="Table-of-contents">
<h2>Table of contents<a class="headerlink" href="#Table-of-contents" title="Permalink to this headline">¶</a></h2>
<p>Installation and setup Creating your first neural network with TF-Slim
Reading Data with TF-Slim Training a convolutional neural network (CNN)
Using pre-trained models</p>
</div>
<div class="section" id="Installation-and-setup">
<h2>Installation and setup<a class="headerlink" href="#Installation-and-setup" title="Permalink to this headline">¶</a></h2>
<p>Since the stable release of TF 1.0, the latest version of slim has been
available as <code class="docutils literal notranslate"><span class="pre">tf.contrib.slim</span></code>. To test that your installation is
working, execute the following command; it should run without raising
any errors.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;import tensorflow.contrib.slim as slim; eval = slim.evaluation.evaluate_once&quot;</span>
</pre></div>
</div>
<p>Although, to use TF-Slim for image classification (as we do in this
notebook), you also have to install the TF-Slim image models library
from
<a class="reference external" href="https://github.com/tensorflow/models/tree/master/research/slim">here</a>.
Let’s suppose you install this into a directory called TF_MODELS. Then
you should change directory to TF_MODELS/research/slim <strong>before</strong>
running this notebook, so that these files are in your python path.</p>
<p>To check you’ve got these two steps to work, just execute the cell
below. If it complains about unknown modules, restart the notebook after
moving to the TF-Slim models directory.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">dataset_utils</span>

<span class="c1"># Main slim library</span>
<span class="kn">from</span> <span class="nn">tensorflow.contrib</span> <span class="kn">import</span> <span class="n">slim</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Creating-your-first-neural-network-with-TF-Slim">
<h2>Creating your first neural network with TF-Slim<a class="headerlink" href="#Creating-your-first-neural-network-with-TF-Slim" title="Permalink to this headline">¶</a></h2>
<p>Below we give some code to create a simple multilayer perceptron (MLP)
which can be used for regression problems. The model has 2 hidden
layers. The output is a single node. When this function is called, it
will create various nodes, and silently add them to whichever global TF
graph is currently in scope. When a node which corresponds to a layer
with adjustable parameters (eg., a fully connected layer) is created,
additional parameter variable nodes are silently created, and added to
the graph. (We will discuss how to train the parameters later.)</p>
<p>We use variable scope to put all the nodes under a common name, so that
the graph has some hierarchical structure. This is useful when we want
to visualize the TF graph in tensorboard, or if we want to query related
variables. The fully connected layers all use the same L2 weight decay
and ReLu activations, as specified by <strong>arg_scope</strong>. (However, the
final layer overrides these defaults, and uses an identity activation
function.)</p>
<p>We also illustrate how to add a dropout layer after the first fully
connected layer (FC1). Note that at test time, we do not drop out nodes,
but instead use the average activations; hence we need to know whether
the model is being constructed for training or testing, since the
computational graph will be different in the two cases (although the
variables, storing the model parameters, will be shared, since they have
the same name/scope).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">regression_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;deep_regression&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates the regression model.</span>

<span class="sd">    Args:</span>
<span class="sd">        inputs: A node that yields a `Tensor` of size [batch_size, dimensions].</span>
<span class="sd">        is_training: Whether or not we&#39;re currently training the model.</span>
<span class="sd">        scope: An optional variable_op scope for the model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        predictions: 1-D `Tensor` of shape [batch_size] of responses.</span>
<span class="sd">        end_points: A dict of end points representing the hidden layers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="s1">&#39;deep_regression&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">inputs</span><span class="p">]):</span>
        <span class="n">end_points</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Set the default weight _regularizer and acvitation for each fully_connected layer.</span>
        <span class="k">with</span> <span class="n">slim</span><span class="o">.</span><span class="n">arg_scope</span><span class="p">([</span><span class="n">slim</span><span class="o">.</span><span class="n">fully_connected</span><span class="p">],</span>
                            <span class="n">activation_fn</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span>
                            <span class="n">weights_regularizer</span><span class="o">=</span><span class="n">slim</span><span class="o">.</span><span class="n">l2_regularizer</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)):</span>

            <span class="c1"># Creates a fully connected layer from the inputs with 32 hidden units.</span>
            <span class="n">net</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">fully_connected</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;fc1&#39;</span><span class="p">)</span>
            <span class="n">end_points</span><span class="p">[</span><span class="s1">&#39;fc1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span>

            <span class="c1"># Adds a dropout layer to prevent over-fitting.</span>
            <span class="n">net</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="n">is_training</span><span class="p">)</span>

            <span class="c1"># Adds another fully connected layer with 16 hidden units.</span>
            <span class="n">net</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">fully_connected</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;fc2&#39;</span><span class="p">)</span>
            <span class="n">end_points</span><span class="p">[</span><span class="s1">&#39;fc2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span>

            <span class="c1"># Creates a fully-connected layer with a single hidden unit. Note that the</span>
            <span class="c1"># layer is made linear by setting activation_fn=None.</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">fully_connected</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;prediction&#39;</span><span class="p">)</span>
            <span class="n">end_points</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span>

            <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">end_points</span>
</pre></div>
</div>
</div>
<div class="section" id="Let's-create-the-model-and-examine-its-structure.">
<h3>Let’s create the model and examine its structure.<a class="headerlink" href="#Let's-create-the-model-and-examine-its-structure." title="Permalink to this headline">¶</a></h3>
<p>We create a TF graph and call regression_model(), which adds nodes
(tensors) to the graph. We then examine their shape, and print the names
of all the model variables which have been implicitly created inside of
each layer. We see that the names of the variables follow the scopes
that we specified.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="c1"># Dummy placeholders for arbitrary number of 1d inputs and outputs</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Build model</span>
    <span class="n">predictions</span><span class="p">,</span> <span class="n">end_points</span> <span class="o">=</span> <span class="n">regression_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="c1"># Print name and shape of each tensor.</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Layers&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">end_points</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;name = {}, shape = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()))</span>

    <span class="c1"># Print name and shape of parameter nodes  (values not yet initialized)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Parameters&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">slim</span><span class="o">.</span><span class="n">get_model_variables</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;name = {}, shape = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()))</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Let's-create-some-1d-regression-data-.">
<h3>Let’s create some 1d regression data .<a class="headerlink" href="#Let's-create-some-1d-regression-data-." title="Permalink to this headline">¶</a></h3>
<p>We will train and test the model on some noisy observations of a
nonlinear function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">produce_batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">noise</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">xs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">ys</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)]</span>

<span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">produce_batch</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">produce_batch</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Let's-fit-the-model-to-the-data">
<h3>Let’s fit the model to the data<a class="headerlink" href="#Let's-fit-the-model-to-the-data" title="Permalink to this headline">¶</a></h3>
<p>The user has to specify the loss function and the optimizer, and slim
does the rest. In particular, the slim.learning.train function does the
following:</p>
<ul class="simple">
<li>For each iteration, evaluate the train_op, which updates the
parameters using the optimizer applied to the current minibatch.
Also, update the global_step.</li>
<li>Occasionally store the model checkpoint in the specified directory.
This is useful in case your machine crashes - then you can simply
restart from the specified checkpoint.</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">convert_data_to_tensors</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">inputs</span><span class="o">.</span><span class="n">set_shape</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">set_shape</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># The following snippet trains the regression model using a mean_squared_error loss.</span>
<span class="n">ckpt_dir</span> <span class="o">=</span> <span class="s1">&#39;/tmp/regression_model/&#39;</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">convert_data_to_tensors</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># Make the model.</span>
    <span class="n">predictions</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">regression_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Add the loss function to the graph.</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">)</span>

    <span class="c1"># The total loss is the user&#39;s loss plus any regularization losses.</span>
    <span class="n">total_loss</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">get_total_loss</span><span class="p">()</span>

    <span class="c1"># Specify the optimizer and create the train op:</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="n">train_op</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">learning</span><span class="o">.</span><span class="n">create_train_op</span><span class="p">(</span><span class="n">total_loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>

    <span class="c1"># Run the training inside a session.</span>
    <span class="n">final_loss</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">learning</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
        <span class="n">train_op</span><span class="p">,</span>
        <span class="n">logdir</span><span class="o">=</span><span class="n">ckpt_dir</span><span class="p">,</span>
        <span class="n">number_of_steps</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
        <span class="n">save_summaries_secs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">log_every_n_steps</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Finished training. Last batch loss:&quot;</span><span class="p">,</span> <span class="n">final_loss</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Checkpoint saved in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ckpt_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Training-with-multiple-loss-functions.">
<h3>Training with multiple loss functions.<a class="headerlink" href="#Training-with-multiple-loss-functions." title="Permalink to this headline">¶</a></h3>
<p>Sometimes we have multiple objectives we want to simultaneously
optimize. In slim, it is easy to add more losses, as we show below. (We
do not optimize the total loss in this example, but we show how to
compute it.)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">convert_data_to_tensors</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">predictions</span><span class="p">,</span> <span class="n">end_points</span> <span class="o">=</span> <span class="n">regression_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Add multiple loss nodes.</span>
    <span class="n">mean_squared_error_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">)</span>
    <span class="n">absolute_difference_loss</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">absolute_difference</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>

    <span class="c1"># The following two ways to compute the total loss are equivalent</span>
    <span class="n">regularization_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">(</span><span class="n">slim</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">get_regularization_losses</span><span class="p">())</span>
    <span class="n">total_loss1</span> <span class="o">=</span> <span class="n">mean_squared_error_loss</span> <span class="o">+</span> <span class="n">absolute_difference_loss</span> <span class="o">+</span> <span class="n">regularization_loss</span>

    <span class="c1"># Regularization Loss is included in the total loss by default.</span>
    <span class="c1"># This is good for training, but not for testing.</span>
    <span class="n">total_loss2</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">get_total_loss</span><span class="p">(</span><span class="n">add_regularization_losses</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">init_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init_op</span><span class="p">)</span> <span class="c1"># Will initialize the parameters with random weights.</span>

        <span class="n">total_loss1</span><span class="p">,</span> <span class="n">total_loss2</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">total_loss1</span><span class="p">,</span> <span class="n">total_loss2</span><span class="p">])</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Total Loss1: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">total_loss1</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Total Loss2: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">total_loss2</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Regularization Losses:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">slim</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">get_regularization_losses</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Loss Functions:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">slim</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">get_losses</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Let's-load-the-saved-model-and-use-it-for-prediction.">
<h3>Let’s load the saved model and use it for prediction.<a class="headerlink" href="#Let's-load-the-saved-model-and-use-it-for-prediction." title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">convert_data_to_tensors</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

    <span class="c1"># Create the model structure. (Parameters will be loaded below.)</span>
    <span class="n">predictions</span><span class="p">,</span> <span class="n">end_points</span> <span class="o">=</span> <span class="n">regression_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Make a session which restores the old parameters from a checkpoint.</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Supervisor</span><span class="p">(</span><span class="n">logdir</span><span class="o">=</span><span class="n">ckpt_dir</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">sv</span><span class="o">.</span><span class="n">managed_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">inputs</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;red=true, blue=predicted&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Let's-compute-various-evaluation-metrics-on-the-test-set.">
<h3>Let’s compute various evaluation metrics on the test set.<a class="headerlink" href="#Let's-compute-various-evaluation-metrics-on-the-test-set." title="Permalink to this headline">¶</a></h3>
<p>In TF-Slim termiology, losses are optimized, but metrics (which may not
be differentiable, e.g., precision and recall) are just measured. As an
illustration, the code below computes mean squared error and mean
absolute error metrics on the test set.</p>
<p>Each metric declaration creates several local variables (which must be
initialized via tf.initialize_local_variables()) and returns both a
value_op and an update_op. When evaluated, the value_op returns the
current value of the metric. The update_op loads a new batch of data,
runs the model, obtains the predictions and accumulates the metric
statistics appropriately before returning the current value of the
metric. We store these value nodes and update nodes in 2 dictionaries.</p>
<p>After creating the metric nodes, we can pass them to
slim.evaluation.evaluation, which repeatedly evaluates these nodes the
specified number of times. (This allows us to compute the evaluation in
a streaming fashion across minibatches, which is usefulf for large
datasets.) Finally, we print the final value of each metric.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">convert_data_to_tensors</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    <span class="n">predictions</span><span class="p">,</span> <span class="n">end_points</span> <span class="o">=</span> <span class="n">regression_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Specify metrics to evaluate:</span>
    <span class="n">names_to_value_nodes</span><span class="p">,</span> <span class="n">names_to_update_nodes</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">aggregate_metric_map</span><span class="p">({</span>
      <span class="s1">&#39;Mean Squared Error&#39;</span><span class="p">:</span> <span class="n">slim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">streaming_mean_squared_error</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">),</span>
      <span class="s1">&#39;Mean Absolute Error&#39;</span><span class="p">:</span> <span class="n">slim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">streaming_mean_absolute_error</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="c1"># Make a session which restores the old graph parameters, and then run eval.</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Supervisor</span><span class="p">(</span><span class="n">logdir</span><span class="o">=</span><span class="n">ckpt_dir</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">sv</span><span class="o">.</span><span class="n">managed_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">metric_values</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">evaluation</span><span class="o">.</span><span class="n">evaluation</span><span class="p">(</span>
            <span class="n">sess</span><span class="p">,</span>
            <span class="n">num_evals</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># Single pass over data</span>
            <span class="n">eval_op</span><span class="o">=</span><span class="n">names_to_update_nodes</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="n">final_op</span><span class="o">=</span><span class="n">names_to_value_nodes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="n">names_to_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">names_to_value_nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">metric_values</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">names_to_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="Reading-Data-with-TF-Slim">
<h1>Reading Data with TF-Slim<a class="headerlink" href="#Reading-Data-with-TF-Slim" title="Permalink to this headline">¶</a></h1>
<p>Reading data with TF-Slim has two main components: A
<a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/slim/python/slim/data/dataset.py">Dataset</a>
and a
<a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/slim/python/slim/data/dataset_data_provider.py">DatasetDataProvider</a>.
The former is a descriptor of a dataset, while the latter performs the
actions necessary for actually reading the data. Lets look at each one
in detail:</p>
<div class="section" id="Dataset">
<h2>Dataset<a class="headerlink" href="#Dataset" title="Permalink to this headline">¶</a></h2>
<p>A TF-Slim
<a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/slim/python/slim/data/dataset.py">Dataset</a>
contains descriptive information about a dataset necessary for reading
it, such as the list of data files and how to decode them. It also
contains metadata including class labels, the size of the train/test
splits and descriptions of the tensors that the dataset provides. For
example, some datasets contain images with labels. Others augment this
data with bounding box annotations, etc. The Dataset object allows us to
write generic code using the same API, regardless of the data content
and encoding type.</p>
<p>TF-Slim’s Dataset works especially well when the data is stored as a
(possibly sharded) <a class="reference external" href="https://www.tensorflow.org/versions/r0.10/how_tos/reading_data/index.html#file-formats">TFRecords
file</a>,
where each record contains a <a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/r0.10/tensorflow/core/example/example.proto">tf.train.Example protocol
buffer</a>.
TF-Slim uses a consistent convention for naming the keys and values
inside each Example record.</p>
</div>
<div class="section" id="DatasetDataProvider">
<h2>DatasetDataProvider<a class="headerlink" href="#DatasetDataProvider" title="Permalink to this headline">¶</a></h2>
<p>A
<a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/slim/python/slim/data/dataset_data_provider.py">DatasetDataProvider</a>
is a class which actually reads the data from a dataset. It is highly
configurable to read the data in various ways that may make a big impact
on the efficiency of your training process. For example, it can be
single or multi-threaded. If your data is sharded across many files, it
can read each files serially, or from every file simultaneously.</p>
</div>
<div class="section" id="Demo:-The-Flowers-Dataset">
<h2>Demo: The Flowers Dataset<a class="headerlink" href="#Demo:-The-Flowers-Dataset" title="Permalink to this headline">¶</a></h2>
<p>For convenience, we’ve include scripts to convert several common image
datasets into TFRecord format and have provided the Dataset descriptor
files necessary for reading them. We demonstrate how easy it is to use
these dataset via the Flowers dataset below.</p>
<div class="section" id="Download-the-Flowers-Dataset">
<h3>Download the Flowers Dataset<a class="headerlink" href="#Download-the-Flowers-Dataset" title="Permalink to this headline">¶</a></h3>
<p>We’ve made available a tarball of the Flowers dataset which has already
been converted to TFRecord format.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">dataset_utils</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://download.tensorflow.org/data/flowers.tar.gz&quot;</span>
<span class="n">flowers_data_dir</span> <span class="o">=</span> <span class="s1">&#39;/tmp/flowers&#39;</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">flowers_data_dir</span><span class="p">):</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">MakeDirs</span><span class="p">(</span><span class="n">flowers_data_dir</span><span class="p">)</span>

<span class="n">dataset_utils</span><span class="o">.</span><span class="n">download_and_uncompress_tarball</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">flowers_data_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Display-some-of-the-data.">
<h3>Display some of the data.<a class="headerlink" href="#Display-some-of-the-data." title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">flowers</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>

<span class="kn">from</span> <span class="nn">tensorflow.contrib</span> <span class="kn">import</span> <span class="n">slim</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">flowers</span><span class="o">.</span><span class="n">get_split</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">flowers_data_dir</span><span class="p">)</span>
    <span class="n">data_provider</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">dataset_data_provider</span><span class="o">.</span><span class="n">DatasetDataProvider</span><span class="p">(</span>
        <span class="n">dataset</span><span class="p">,</span> <span class="n">common_queue_capacity</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">common_queue_min</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">data_provider</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">])</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">slim</span><span class="o">.</span><span class="n">queues</span><span class="o">.</span><span class="n">QueueRunners</span><span class="p">(</span><span class="n">sess</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">np_image</span><span class="p">,</span> <span class="n">np_label</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">])</span>
                <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np_image</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">class_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels_to_names</span><span class="p">[</span><span class="n">np_label</span><span class="p">]</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np_image</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%d</span><span class="s1"> x </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="Convolutional-neural-nets-(CNNs).">
<h1>Convolutional neural nets (CNNs).<a class="headerlink" href="#Convolutional-neural-nets-(CNNs)." title="Permalink to this headline">¶</a></h1>
<p>In this section, we show how to train an image classifier using a simple
CNN.</p>
<p>Below we define a simple CNN. Note that the output layer is linear
function - we will apply softmax transformation externally to the model,
either in the loss function (for training), or in the prediction
function (during testing).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">my_cnn</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">is_training</span><span class="p">):</span>  <span class="c1"># is_training is not used...</span>
    <span class="k">with</span> <span class="n">slim</span><span class="o">.</span><span class="n">arg_scope</span><span class="p">([</span><span class="n">slim</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">],</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">fully_connected</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">192</span><span class="p">)</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">fully_connected</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">net</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="c1"># The model can handle any input size because the first layer is convolutional.</span>
    <span class="c1"># The size of the model is determined when image_node is first passed into the my_cnn function.</span>
    <span class="c1"># Once the variables are initialized, the size of all the weight matrices is fixed.</span>
    <span class="c1"># Because of the fully connected layers, this means that all subsequent images must have the same</span>
    <span class="c1"># input size as the first image.</span>
    <span class="n">batch_size</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">3</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random_uniform</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span><span class="p">],</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Create the model.</span>
    <span class="n">num_classes</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">my_cnn</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>

    <span class="c1"># Initialize all the variables (including parameters) randomly.</span>
    <span class="n">init_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="c1"># Run the init_op, evaluate the model outputs and print the results:</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init_op</span><span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Probabilities Shape:&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">probabilities</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># batch_size x num_classes</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Probabilities:&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Summing across all classes (Should equal 1):&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># Each row sums to 1</span>
</pre></div>
</div>
</div>
<p>Before starting, make sure you’ve run the code to Download the Flowers
dataset. Now, we’ll get a sense of what it looks like to use TF-Slim’s
training functions found in
<a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/slim/python/slim/learning.py">learning.py</a>.
First, we’ll create a function, <code class="docutils literal notranslate"><span class="pre">load_batch</span></code>, that loads batches of
dataset from a dataset. Next, we’ll train a model for a single step
(just to demonstrate the API), and evaluate the results.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">preprocessing</span> <span class="kn">import</span> <span class="n">inception_preprocessing</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>

<span class="kn">from</span> <span class="nn">tensorflow.contrib</span> <span class="kn">import</span> <span class="n">slim</span>


<span class="k">def</span> <span class="nf">load_batch</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">299</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">299</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads a single batch of data.</span>

<span class="sd">    Args:</span>
<span class="sd">      dataset: The dataset to load.</span>
<span class="sd">      batch_size: The number of images in the batch.</span>
<span class="sd">      height: The size of each image after preprocessing.</span>
<span class="sd">      width: The size of each image after preprocessing.</span>
<span class="sd">      is_training: Whether or not we&#39;re currently training or evaluating.</span>

<span class="sd">    Returns:</span>
<span class="sd">      images: A Tensor of size [batch_size, height, width, 3], image samples that have been preprocessed.</span>
<span class="sd">      images_raw: A Tensor of size [batch_size, height, width, 3], image samples that can be used for visualization.</span>
<span class="sd">      labels: A Tensor of size [batch_size], whose values range between 0 and dataset.num_classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_provider</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">dataset_data_provider</span><span class="o">.</span><span class="n">DatasetDataProvider</span><span class="p">(</span>
        <span class="n">dataset</span><span class="p">,</span> <span class="n">common_queue_capacity</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">common_queue_min</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">image_raw</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">data_provider</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">])</span>

    <span class="c1"># Preprocess image for usage by Inception.</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">inception_preprocessing</span><span class="o">.</span><span class="n">preprocess_image</span><span class="p">(</span><span class="n">image_raw</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="n">is_training</span><span class="p">)</span>

    <span class="c1"># Preprocess the image for display purposes.</span>
    <span class="n">image_raw</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image_raw</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">image_raw</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize_images</span><span class="p">(</span><span class="n">image_raw</span><span class="p">,</span> <span class="p">[</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">])</span>
    <span class="n">image_raw</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">image_raw</span><span class="p">)</span>

    <span class="c1"># Batch it up.</span>
    <span class="n">images</span><span class="p">,</span> <span class="n">images_raw</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span>
          <span class="p">[</span><span class="n">image</span><span class="p">,</span> <span class="n">image_raw</span><span class="p">,</span> <span class="n">label</span><span class="p">],</span>
          <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
          <span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
          <span class="n">capacity</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">images_raw</span><span class="p">,</span> <span class="n">labels</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">flowers</span>

<span class="c1"># This might take a few minutes.</span>
<span class="n">train_dir</span> <span class="o">=</span> <span class="s1">&#39;/tmp/tfslim_model/&#39;</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Will save model to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">train_dir</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">flowers</span><span class="o">.</span><span class="n">get_split</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">flowers_data_dir</span><span class="p">)</span>
    <span class="n">images</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">load_batch</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

    <span class="c1"># Create the model:</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">my_cnn</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Specify the loss function:</span>
    <span class="n">one_hot_labels</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">one_hot_encoding</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">num_classes</span><span class="p">)</span>
    <span class="n">slim</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">softmax_cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">one_hot_labels</span><span class="p">)</span>
    <span class="n">total_loss</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">get_total_loss</span><span class="p">()</span>

    <span class="c1"># Create some summaries to visualize the training process:</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="s1">&#39;losses/Total Loss&#39;</span><span class="p">,</span> <span class="n">total_loss</span><span class="p">)</span>

    <span class="c1"># Specify the optimizer and create the train op:</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">train_op</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">learning</span><span class="o">.</span><span class="n">create_train_op</span><span class="p">(</span><span class="n">total_loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>

    <span class="c1"># Run the training:</span>
    <span class="n">final_loss</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">learning</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
      <span class="n">train_op</span><span class="p">,</span>
      <span class="n">logdir</span><span class="o">=</span><span class="n">train_dir</span><span class="p">,</span>
      <span class="n">number_of_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># For speed, we just do 1 epoch</span>
      <span class="n">save_summaries_secs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Finished training. Final batch loss </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">final_loss</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>As we discussed above, we can compute various metrics besides the loss.
Below we show how to compute prediction accuracy of the trained model,
as well as top-5 classification accuracy. (The difference between
evaluation and evaluation_loop is that the latter writes the results to
a log directory, so they can be viewed in tensorboard.)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">flowers</span>

<span class="c1"># This might take a few minutes.</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">flowers</span><span class="o">.</span><span class="n">get_split</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">flowers_data_dir</span><span class="p">)</span>
    <span class="n">images</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">load_batch</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

    <span class="n">logits</span> <span class="o">=</span> <span class="n">my_cnn</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Define the metrics:</span>
    <span class="n">names_to_values</span><span class="p">,</span> <span class="n">names_to_updates</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">aggregate_metric_map</span><span class="p">({</span>
        <span class="s1">&#39;eval/Accuracy&#39;</span><span class="p">:</span> <span class="n">slim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">streaming_accuracy</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span><span class="p">),</span>
        <span class="s1">&#39;eval/Recall@5&#39;</span><span class="p">:</span> <span class="n">slim</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">streaming_recall_at_k</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="p">})</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Running evaluation Loop...&#39;</span><span class="p">)</span>
    <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="n">train_dir</span><span class="p">)</span>
    <span class="n">metric_values</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">evaluation</span><span class="o">.</span><span class="n">evaluate_once</span><span class="p">(</span>
        <span class="n">master</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">checkpoint_path</span><span class="o">=</span><span class="n">checkpoint_path</span><span class="p">,</span>
        <span class="n">logdir</span><span class="o">=</span><span class="n">train_dir</span><span class="p">,</span>
        <span class="n">eval_op</span><span class="o">=</span><span class="n">names_to_updates</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
        <span class="n">final_op</span><span class="o">=</span><span class="n">names_to_values</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="n">names_to_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">names_to_values</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">metric_values</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names_to_values</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">names_to_values</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Using-pre-trained-models">
<h1>Using pre-trained models<a class="headerlink" href="#Using-pre-trained-models" title="Permalink to this headline">¶</a></h1>
<p>Neural nets work best when they have many parameters, making them very
flexible function approximators. However, this means they must be
trained on big datasets. Since this process is slow, we provide various
pre-trained models - see the list
<a class="reference external" href="https://github.com/tensorflow/models/tree/master/research/slim#pre-trained-models">here</a>.</p>
<p>You can either use these models as-is, or you can perform “surgery” on
them, to modify them for some other task. For example, it is common to
“chop off” the final pre-softmax layer, and replace it with a new set of
weights corresponding to some new set of labels. You can then quickly
fine tune the new model on a small new dataset. We illustrate this
below, using inception-v1 as the base model. While models like Inception
V3 are more powerful, Inception V1 is used for speed purposes.</p>
<p>Take into account that VGG and ResNet final layers have only 1000
outputs rather than 1001. The ImageNet dataset provied has an empty
background class which can be used to fine-tune the model to other
tasks. VGG and ResNet models provided here don’t use that class. We
provide two examples of using pretrained models: Inception V1 and VGG-19
models to highlight this difference.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">dataset_utils</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://download.tensorflow.org/models/inception_v1_2016_08_28.tar.gz&quot;</span>
<span class="n">checkpoints_dir</span> <span class="o">=</span> <span class="s1">&#39;/tmp/checkpoints&#39;</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">checkpoints_dir</span><span class="p">):</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">MakeDirs</span><span class="p">(</span><span class="n">checkpoints_dir</span><span class="p">)</span>

<span class="n">dataset_utils</span><span class="o">.</span><span class="n">download_and_uncompress_tarball</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">checkpoints_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We have to convert each image to the size expected by the model
checkpoint. There is no easy way to determine this size from the
checkpoint itself. So we use a preprocessor to enforce this.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">urllib2</span> <span class="kn">as</span> <span class="nn">urllib</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">urllib.request</span> <span class="kn">as</span> <span class="nn">urllib</span>

<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">imagenet</span>
<span class="kn">from</span> <span class="nn">nets</span> <span class="kn">import</span> <span class="n">inception</span>
<span class="kn">from</span> <span class="nn">preprocessing</span> <span class="kn">import</span> <span class="n">inception_preprocessing</span>

<span class="kn">from</span> <span class="nn">tensorflow.contrib</span> <span class="kn">import</span> <span class="n">slim</span>

<span class="n">image_size</span> <span class="o">=</span> <span class="n">inception</span><span class="o">.</span><span class="n">inception_v1</span><span class="o">.</span><span class="n">default_image_size</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://upload.wikimedia.org/wikipedia/commons/7/70/EnglishCockerSpaniel_simon.jpg&#39;</span>
    <span class="n">image_string</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">image_string</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">processed_image</span> <span class="o">=</span> <span class="n">inception_preprocessing</span><span class="o">.</span><span class="n">preprocess_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">processed_images</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">processed_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Create the model, use the default arg scope to configure the batch norm parameters.</span>
    <span class="k">with</span> <span class="n">slim</span><span class="o">.</span><span class="n">arg_scope</span><span class="p">(</span><span class="n">inception</span><span class="o">.</span><span class="n">inception_v1_arg_scope</span><span class="p">()):</span>
        <span class="n">logits</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">inception</span><span class="o">.</span><span class="n">inception_v1</span><span class="p">(</span><span class="n">processed_images</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">1001</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>

    <span class="n">init_fn</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">assign_from_checkpoint_fn</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoints_dir</span><span class="p">,</span> <span class="s1">&#39;inception_v1.ckpt&#39;</span><span class="p">),</span>
        <span class="n">slim</span><span class="o">.</span><span class="n">get_model_variables</span><span class="p">(</span><span class="s1">&#39;InceptionV1&#39;</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">init_fn</span><span class="p">(</span><span class="n">sess</span><span class="p">)</span>
        <span class="n">np_image</span><span class="p">,</span> <span class="n">probabilities</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">image</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">])</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">probabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:]</span>
        <span class="n">sorted_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="o">-</span><span class="n">probabilities</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">names</span> <span class="o">=</span> <span class="n">imagenet</span><span class="o">.</span><span class="n">create_readable_names_for_imagenet_labels</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">sorted_inds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Probability </span><span class="si">%0.2f%%</span><span class="s1"> =&gt; [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">probabilities</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">dataset_utils</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://download.tensorflow.org/models/vgg_16_2016_08_28.tar.gz&quot;</span>
<span class="n">checkpoints_dir</span> <span class="o">=</span> <span class="s1">&#39;/tmp/checkpoints&#39;</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">checkpoints_dir</span><span class="p">):</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">MakeDirs</span><span class="p">(</span><span class="n">checkpoints_dir</span><span class="p">)</span>

<span class="n">dataset_utils</span><span class="o">.</span><span class="n">download_and_uncompress_tarball</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">checkpoints_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We have to convert each image to the size expected by the model
checkpoint. There is no easy way to determine this size from the
checkpoint itself. So we use a preprocessor to enforce this. Pay
attention to the difference caused by 1000 classes instead of 1001.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">urllib2</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">urllib.request</span> <span class="kn">as</span> <span class="nn">urllib</span>

<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">imagenet</span>
<span class="kn">from</span> <span class="nn">nets</span> <span class="kn">import</span> <span class="n">vgg</span>
<span class="kn">from</span> <span class="nn">preprocessing</span> <span class="kn">import</span> <span class="n">vgg_preprocessing</span>

<span class="kn">from</span> <span class="nn">tensorflow.contrib</span> <span class="kn">import</span> <span class="n">slim</span>

<span class="n">image_size</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">vgg_16</span><span class="o">.</span><span class="n">default_image_size</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://upload.wikimedia.org/wikipedia/commons/d/d9/First_Student_IC_school_bus_202076.jpg&#39;</span>
    <span class="n">image_string</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">image_string</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">processed_image</span> <span class="o">=</span> <span class="n">vgg_preprocessing</span><span class="o">.</span><span class="n">preprocess_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">processed_images</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">processed_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Create the model, use the default arg scope to configure the batch norm parameters.</span>
    <span class="k">with</span> <span class="n">slim</span><span class="o">.</span><span class="n">arg_scope</span><span class="p">(</span><span class="n">vgg</span><span class="o">.</span><span class="n">vgg_arg_scope</span><span class="p">()):</span>
        <span class="c1"># 1000 classes instead of 1001.</span>
        <span class="n">logits</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">vgg_16</span><span class="p">(</span><span class="n">processed_images</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>

    <span class="n">init_fn</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">assign_from_checkpoint_fn</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoints_dir</span><span class="p">,</span> <span class="s1">&#39;vgg_16.ckpt&#39;</span><span class="p">),</span>
        <span class="n">slim</span><span class="o">.</span><span class="n">get_model_variables</span><span class="p">(</span><span class="s1">&#39;vgg_16&#39;</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">init_fn</span><span class="p">(</span><span class="n">sess</span><span class="p">)</span>
        <span class="n">np_image</span><span class="p">,</span> <span class="n">probabilities</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">image</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">])</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">probabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:]</span>
        <span class="n">sorted_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="o">-</span><span class="n">probabilities</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">names</span> <span class="o">=</span> <span class="n">imagenet</span><span class="o">.</span><span class="n">create_readable_names_for_imagenet_labels</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">sorted_inds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># Shift the index of a class name by one.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Probability </span><span class="si">%0.2f%%</span><span class="s1"> =&gt; [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">probabilities</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<p>We will fine tune the inception model on the Flowers dataset.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Note that this may take several minutes.</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">flowers</span>
<span class="kn">from</span> <span class="nn">nets</span> <span class="kn">import</span> <span class="n">inception</span>
<span class="kn">from</span> <span class="nn">preprocessing</span> <span class="kn">import</span> <span class="n">inception_preprocessing</span>

<span class="kn">from</span> <span class="nn">tensorflow.contrib</span> <span class="kn">import</span> <span class="n">slim</span>
<span class="n">image_size</span> <span class="o">=</span> <span class="n">inception</span><span class="o">.</span><span class="n">inception_v1</span><span class="o">.</span><span class="n">default_image_size</span>


<span class="k">def</span> <span class="nf">get_init_fn</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns a function run by the chief worker to warm-start the training.&quot;&quot;&quot;</span>
    <span class="n">checkpoint_exclude_scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;InceptionV1/Logits&quot;</span><span class="p">,</span> <span class="s2">&quot;InceptionV1/AuxLogits&quot;</span><span class="p">]</span>

    <span class="n">exclusions</span> <span class="o">=</span> <span class="p">[</span><span class="n">scope</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">checkpoint_exclude_scopes</span><span class="p">]</span>

    <span class="n">variables_to_restore</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">slim</span><span class="o">.</span><span class="n">get_model_variables</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">exclusion</span> <span class="ow">in</span> <span class="n">exclusions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">exclusion</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">variables_to_restore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">slim</span><span class="o">.</span><span class="n">assign_from_checkpoint_fn</span><span class="p">(</span>
      <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoints_dir</span><span class="p">,</span> <span class="s1">&#39;inception_v1.ckpt&#39;</span><span class="p">),</span>
      <span class="n">variables_to_restore</span><span class="p">)</span>


<span class="n">train_dir</span> <span class="o">=</span> <span class="s1">&#39;/tmp/inception_finetuned/&#39;</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">flowers</span><span class="o">.</span><span class="n">get_split</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">flowers_data_dir</span><span class="p">)</span>
    <span class="n">images</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">load_batch</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">image_size</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">image_size</span><span class="p">)</span>

    <span class="c1"># Create the model, use the default arg scope to configure the batch norm parameters.</span>
    <span class="k">with</span> <span class="n">slim</span><span class="o">.</span><span class="n">arg_scope</span><span class="p">(</span><span class="n">inception</span><span class="o">.</span><span class="n">inception_v1_arg_scope</span><span class="p">()):</span>
        <span class="n">logits</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">inception</span><span class="o">.</span><span class="n">inception_v1</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Specify the loss function:</span>
    <span class="n">one_hot_labels</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">one_hot_encoding</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">num_classes</span><span class="p">)</span>
    <span class="n">slim</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">softmax_cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">one_hot_labels</span><span class="p">)</span>
    <span class="n">total_loss</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">get_total_loss</span><span class="p">()</span>

    <span class="c1"># Create some summaries to visualize the training process:</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="s1">&#39;losses/Total Loss&#39;</span><span class="p">,</span> <span class="n">total_loss</span><span class="p">)</span>

    <span class="c1"># Specify the optimizer and create the train op:</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">train_op</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">learning</span><span class="o">.</span><span class="n">create_train_op</span><span class="p">(</span><span class="n">total_loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>

    <span class="c1"># Run the training:</span>
    <span class="n">final_loss</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">learning</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
        <span class="n">train_op</span><span class="p">,</span>
        <span class="n">logdir</span><span class="o">=</span><span class="n">train_dir</span><span class="p">,</span>
        <span class="n">init_fn</span><span class="o">=</span><span class="n">get_init_fn</span><span class="p">(),</span>
        <span class="n">number_of_steps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Finished training. Last batch loss </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">final_loss</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">flowers</span>
<span class="kn">from</span> <span class="nn">nets</span> <span class="kn">import</span> <span class="n">inception</span>

<span class="kn">from</span> <span class="nn">tensorflow.contrib</span> <span class="kn">import</span> <span class="n">slim</span>

<span class="n">image_size</span> <span class="o">=</span> <span class="n">inception</span><span class="o">.</span><span class="n">inception_v1</span><span class="o">.</span><span class="n">default_image_size</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">3</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">flowers</span><span class="o">.</span><span class="n">get_split</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">flowers_data_dir</span><span class="p">)</span>
    <span class="n">images</span><span class="p">,</span> <span class="n">images_raw</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">load_batch</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">image_size</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">image_size</span><span class="p">)</span>

    <span class="c1"># Create the model, use the default arg scope to configure the batch norm parameters.</span>
    <span class="k">with</span> <span class="n">slim</span><span class="o">.</span><span class="n">arg_scope</span><span class="p">(</span><span class="n">inception</span><span class="o">.</span><span class="n">inception_v1_arg_scope</span><span class="p">()):</span>
        <span class="n">logits</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">inception</span><span class="o">.</span><span class="n">inception_v1</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>

    <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="n">train_dir</span><span class="p">)</span>
    <span class="n">init_fn</span> <span class="o">=</span> <span class="n">slim</span><span class="o">.</span><span class="n">assign_from_checkpoint_fn</span><span class="p">(</span>
      <span class="n">checkpoint_path</span><span class="p">,</span>
      <span class="n">slim</span><span class="o">.</span><span class="n">get_variables_to_restore</span><span class="p">())</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">slim</span><span class="o">.</span><span class="n">queues</span><span class="o">.</span><span class="n">QueueRunners</span><span class="p">(</span><span class="n">sess</span><span class="p">):</span>
            <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">initialize_local_variables</span><span class="p">())</span>
            <span class="n">init_fn</span><span class="p">(</span><span class="n">sess</span><span class="p">)</span>
            <span class="n">np_probabilities</span><span class="p">,</span> <span class="n">np_images_raw</span><span class="p">,</span> <span class="n">np_labels</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">images_raw</span><span class="p">,</span> <span class="n">labels</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np_images_raw</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">true_label</span> <span class="o">=</span> <span class="n">np_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">predicted_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">predicted_name</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels_to_names</span><span class="p">[</span><span class="n">predicted_label</span><span class="p">]</span>
                <span class="n">true_name</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels_to_names</span><span class="p">[</span><span class="n">true_label</span><span class="p">]</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Ground Truth: [</span><span class="si">%s</span><span class="s1">], Prediction [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">true_name</span><span class="p">,</span> <span class="n">predicted_name</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Applied Brain Research.
      Last updated on Jun 14, 2018.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  <!-- adapted from sphinx_rtd_theme versions.html -->

<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Versions</span>
        v0.4.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            
            
                <dd><a href="../../../../../examples/models/research/slim/slim_walkthrough.html">latest</a></dd>
            

            
                
                    <dd><a href="../../../../../v1.0.0/examples/models/research/slim/slim_walkthrough.html">v1.0.0</a></dd>
                
            
                
                    <dd><a href="../../../../../v0.6.2/examples/models/research/slim/slim_walkthrough.html">v0.6.2</a></dd>
                
            
                
                    <dd><a href="../../../../../v0.6.1/examples/models/research/slim/slim_walkthrough.html">v0.6.1</a></dd>
                
            
                
                    <dd><a href="../../../../../v0.6.0/examples/models/research/slim/slim_walkthrough.html">v0.6.0</a></dd>
                
            
                
                    <dd><a href="../../../../../v0.5.2/examples/models/research/slim/slim_walkthrough.html">v0.5.2</a></dd>
                
            
                
                    <dd><a href="../../../../../v0.5.1/examples/models/research/slim/slim_walkthrough.html">v0.5.1</a></dd>
                
            
                
                    <dd><a href="../../../../../v0.5.0/examples/models/research/slim/slim_walkthrough.html">v0.5.0</a></dd>
                
            
                
                    <dd>v0.4.0</dd>
                
            
                
                    <dd><a href="../../../../../v0.3.1/examples/models/research/slim/slim_walkthrough.html">v0.3.1</a></dd>
                
            
                
                    <dd><a href="../../../../../v0.3.0/examples/models/research/slim/slim_walkthrough.html">v0.3.0</a></dd>
                
            
                
                    <dd><a href="../../../../../v0.2.0/examples/models/research/slim/slim_walkthrough.html">v0.2.0</a></dd>
                
            
                
                    <dd><a href="../../../../..//examples/models/research/slim/slim_walkthrough.html"></a></dd>
                
            
        </dl>
    </div>
</div>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'0.4.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>