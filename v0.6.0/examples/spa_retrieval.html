

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Optimizing a structured semantic pointer model &mdash; NengoDL documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static\custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Optimizing a structured semantic pointer model with temporal dynamics" href="spa_memory.html" />
    <link rel="prev" title="Examples" href="../examples.html" /> 

  

<!-- Google Tag Manager -->
<script>
 (function (w, d, s, l, i) {
   w[l] = w[l] || [];
   w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
   var f = d.getElementsByTagName(s)[0],
       j = d.createElement(s),
       dl = l != "dataLayer" ? "&l=" + l : "";
   j.async = true;
   j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
   f.parentNode.insertBefore(j, f);
 })(window, document, "script", "dataLayer", "GTM-KWCR2HN");
</script>
<!-- End Google Tag Manager -->
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> NengoDL
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../frontend.html">User documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="nef_init.html">Optimizing the parameters of a Nengo model</a></li>
<li class="toctree-l2"><a class="reference internal" href="pretrained_model.html">Inserting a TensorFlow network into a Nengo model</a></li>
<li class="toctree-l2"><a class="reference internal" href="spiking_mnist.html">Optimizing spiking neural networks</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Optimizing a structured semantic pointer model</a></li>
<li class="toctree-l2"><a class="reference internal" href="spa_memory.html">Optimizing a structured semantic pointer model with temporal dynamics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">Additional resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backend.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project.html">Project information</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NengoDL</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../examples.html">Examples</a> &raquo;</li>
        
      <li>Optimizing a structured semantic pointer model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/examples/spa_retrieval.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Optimizing-a-structured-semantic-pointer-model">
<h1>Optimizing a structured semantic pointer model<a class="headerlink" href="#Optimizing-a-structured-semantic-pointer-model" title="Permalink to this headline">¶</a></h1>
<p>The purpose of this notebook is to illustrate how Nengo DL can be used
to optimize a more complex cognitive model, involving the retrieval of
information from highly structured <a class="reference external" href="https://www.nengo.ai/build-a-brain/index.html">semantic
pointers</a>. We will
create a network that takes a collection of information as input
(encoded using semantic pointers), and train it to retrieve some
specific element from that collection.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">nengo</span>
<span class="kn">import</span> <span class="nn">nengo.spa</span> <span class="kn">as</span> <span class="nn">spa</span>
<span class="kn">import</span> <span class="nn">nengo_dl</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>

<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlretrieve</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<p>The first thing to do is define a function that produces random examples
of structured semantic pointers. Each example consists of a collection
of role-filler pairs of the following form:</p>
<p><span class="math notranslate nohighlight">\(TRACE_0 = \sum_{j=0}^N Role_{0,j} \circledast Filler_{0,j}\)</span></p>
<p>where terms like <span class="math notranslate nohighlight">\(Role\)</span> refer to simpler semantic pointers (i.e.,
random vectors), the <span class="math notranslate nohighlight">\(\circledast\)</span> symbol denotes circular
convolution, and the summation means vector addition. That is, we define
different pieces of information consisting of Roles and Fillers, and
then we sum the information together in order to generate the full
trace. As an example of how this might look in practice, we could encode
information about a dog as</p>
<p><span class="math notranslate nohighlight">\(DOG = COLOUR \circledast BROWN + LEGS \circledast FOUR + TEXTURE \circledast FURRY + ...\)</span></p>
<p>The goal of the system is then to retrieve a cued piece of information
from the semantic pointer. For example, if we gave the network the trace
<span class="math notranslate nohighlight">\(DOG\)</span> and the cue <span class="math notranslate nohighlight">\(COLOUR\)</span> it should output <span class="math notranslate nohighlight">\(BROWN\)</span>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">n_items</span><span class="p">,</span> <span class="n">n_pairs</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
    <span class="c1"># the vocabulary object will handle the creation of semantic pointers for us</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="n">spa</span><span class="o">.</span><span class="n">Vocabulary</span><span class="p">(</span><span class="n">dimensions</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">max_similarity</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># initialize arrays of shape (n_inputs, n_steps, dims)</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_items</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dims</span><span class="p">))</span>
    <span class="n">cues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_items</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dims</span><span class="p">))</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_items</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dims</span><span class="p">))</span>

    <span class="c1"># iterate through all of the examples to be generated</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_items</span><span class="p">):</span>
        <span class="n">role_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ROLE_</span><span class="si">%d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pairs</span><span class="p">)]</span>
        <span class="n">filler_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FILLER_</span><span class="si">%d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pairs</span><span class="p">)]</span>

        <span class="c1"># create key for the &#39;trace&#39; of bound pairs (i.e. a structured SP)</span>
        <span class="n">trace_key</span> <span class="o">=</span> <span class="s1">&#39;TRACE_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">trace_ptr</span> <span class="o">=</span> <span class="n">vocab</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> * </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">role_names</span><span class="p">,</span> <span class="n">filler_names</span><span class="p">)))</span>
        <span class="n">trace_ptr</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
        <span class="n">vocab</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">trace_key</span><span class="p">,</span> <span class="n">trace_ptr</span><span class="p">)</span>

        <span class="c1"># pick which element will be cued for retrieval</span>
        <span class="n">cue_idx</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">n_pairs</span><span class="p">)</span>

        <span class="c1"># fill array elements correspond to this example</span>
        <span class="n">traces</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">vocab</span><span class="p">[</span><span class="n">trace_key</span><span class="p">]</span><span class="o">.</span><span class="n">v</span>
        <span class="n">cues</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">vocab</span><span class="p">[</span><span class="s2">&quot;ROLE_</span><span class="si">%d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cue_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">v</span>
        <span class="n">targets</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">vocab</span><span class="p">[</span><span class="s2">&quot;FILLER_</span><span class="si">%d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cue_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">v</span>

    <span class="k">return</span> <span class="n">traces</span><span class="p">,</span> <span class="n">cues</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">vocab</span>
</pre></div>
</div>
</div>
<p>Next we’ll define a Nengo model that retrieves cued items from
structured semantic pointers. So, for a given trace (e.g.,
<span class="math notranslate nohighlight">\(TRACE_0\)</span>) and cue (e.g., <span class="math notranslate nohighlight">\(Role_{0,0}\)</span>), the correct output
would be the corresponding filler (<span class="math notranslate nohighlight">\(Filler_{0,0}\)</span>). The model
we’ll build will perform such retrieval by implementing a computation of
the form:</p>
<p><span class="math notranslate nohighlight">\(TRACE_0 \:\: \circledast \sim Role_{0,0} \approx Filler_{0,0}\)</span></p>
<p>That is, convolving the trace with inverse of the given cue will produce
(approximately) the associated filler. More details about the
mathematics of how/why this works can be found
<a class="reference external" href="https://pdfs.semanticscholar.org/6456/98cdb52b0f1fdcac55da91e56f7ffd935d15.pdf">here</a>.</p>
<p>We can create a model to perform this calculation by using the
<code class="docutils literal notranslate"><span class="pre">nengo.networks.CircularConvolution</span></code> network that comes with Nengo.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">dims</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">minibatch_size</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">n_pairs</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">with</span> <span class="n">nengo</span><span class="o">.</span><span class="n">Network</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span> <span class="k">as</span> <span class="n">net</span><span class="p">:</span>
    <span class="c1"># use rectified linear neurons to ensure differentiability</span>
    <span class="n">net</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">nengo</span><span class="o">.</span><span class="n">Ensemble</span><span class="p">]</span><span class="o">.</span><span class="n">neuron_type</span> <span class="o">=</span> <span class="n">nengo</span><span class="o">.</span><span class="n">RectifiedLinear</span><span class="p">()</span>
    <span class="n">net</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">nengo</span><span class="o">.</span><span class="n">Connection</span><span class="p">]</span><span class="o">.</span><span class="n">synapse</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># provide a pointer and a cue as input to the network</span>
    <span class="n">trace_inp</span> <span class="o">=</span> <span class="n">nengo</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dims</span><span class="p">))</span>
    <span class="n">cue_inp</span> <span class="o">=</span> <span class="n">nengo</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dims</span><span class="p">))</span>

    <span class="c1"># create a convolution network to perform the computation specified above</span>
    <span class="n">cconv</span> <span class="o">=</span> <span class="n">nengo</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">CircularConvolution</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">invert_b</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># connect the trace and cue inputs to the circular convolution network</span>
    <span class="n">nengo</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="n">trace_inp</span><span class="p">,</span> <span class="n">cconv</span><span class="o">.</span><span class="n">input_a</span><span class="p">)</span>
    <span class="n">nengo</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="n">cue_inp</span><span class="p">,</span> <span class="n">cconv</span><span class="o">.</span><span class="n">input_b</span><span class="p">)</span>

    <span class="c1"># probe the output</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">nengo</span><span class="o">.</span><span class="n">Probe</span><span class="p">(</span><span class="n">cconv</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>In order to assess the retrieval accuracy of the model we need a metric
for success. In this case we’ll say that a cue has been successfully
retrieved if the output vector is more similar to the correct filler
vector than it is to any of the other vectors in the vocabulary.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">accuracy</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">t_step</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># provide a simulator instance, the probe being evaluated, the vocab,</span>
    <span class="c1"># the target vectors, and the time step at which to evaluate</span>

    <span class="c1"># get output at the given time step</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">probe</span><span class="p">][:,</span> <span class="n">t_step</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># compute similarity between each output and vocab item</span>
    <span class="n">sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vocab</span><span class="o">.</span><span class="n">vectors</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sims</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># check that the output is most similar to the target</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">vocab</span><span class="o">.</span><span class="n">vectors</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span> <span class="o">==</span> <span class="n">targets</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">acc</span>
</pre></div>
</div>
</div>
<p>Now we can run the model on some test data to check the baseline
retrieval accuracy. Since we used only a small number of neurons in the
circular convolution network, we should expect mediocre results.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># generate some test inputs</span>
<span class="n">test_traces</span><span class="p">,</span> <span class="n">test_cues</span><span class="p">,</span> <span class="n">test_targets</span><span class="p">,</span> <span class="n">test_vocab</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span>
    <span class="n">minibatch_size</span><span class="p">,</span> <span class="n">n_pairs</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<span class="n">test_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">trace_inp</span><span class="p">:</span> <span class="n">test_traces</span><span class="p">,</span> <span class="n">cue_inp</span><span class="p">:</span> <span class="n">test_cues</span><span class="p">}</span>

<span class="c1"># run the simulator for one time step to compute the network outputs</span>
<span class="k">with</span> <span class="n">nengo_dl</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">minibatch_size</span><span class="o">=</span><span class="n">minibatch_size</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span> <span class="k">as</span> <span class="n">sim</span><span class="p">:</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">input_feeds</span><span class="o">=</span><span class="n">test_inputs</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Retrieval accuracy: &#39;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">test_vocab</span><span class="p">,</span> <span class="n">test_targets</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>These results indicate that the model is only rarely performing accurate
retrieval, which means that this network is not very capable of
manipulating structured semantic pointers in a useful way.</p>
<p>We can visualize the similarity of the output for one of the traces to
get a sense of what this accuracy looks like (the similarity to the
correct output is shown in red).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">bars</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_vocab</span><span class="o">.</span><span class="n">vectors</span><span class="p">)),</span>
               <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">test_vocab</span><span class="o">.</span><span class="n">vectors</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">out</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="n">bars</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">test_vocab</span><span class="o">.</span><span class="n">vectors</span> <span class="o">==</span> <span class="n">test_targets</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Vocabulary items&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Similarity&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>We can see that the actual output is not particularly similary to this
desired output, which illustrates that the model is not performing
accurate retrieval.</p>
<p>Now we’ll train the network parameters to improve performance. We won’t
directly optimize retrieval accuracy, but will instead minimize the mean
squared error between the model’s output vectors and the vectors
corresponding to the correct output items for each input cue. We’ll use
a large number of training examples that are distinct from our test
data, so as to avoid explicitly fitting the model parameters to the test
items.</p>
<p>To make this example run a bit quicker we’ll download some pretrained
model parameters by default. Set <code class="docutils literal notranslate"><span class="pre">do_training=True</span></code> to train the model
yourself.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sim</span> <span class="o">=</span> <span class="n">nengo_dl</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">minibatch_size</span><span class="o">=</span><span class="n">minibatch_size</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

<span class="c1"># pick an optimizer and learning rate</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">RMSPropOptimizer</span><span class="p">(</span><span class="mf">2e-3</span><span class="p">)</span>

<span class="n">do_training</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">if</span> <span class="n">do_training</span><span class="p">:</span>
    <span class="c1"># create training data and data feeds</span>
    <span class="n">train_traces</span><span class="p">,</span> <span class="n">train_cues</span><span class="p">,</span> <span class="n">train_targets</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span>
        <span class="n">n_items</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">n_pairs</span><span class="o">=</span><span class="n">n_pairs</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">train_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">trace_inp</span><span class="p">:</span> <span class="n">train_traces</span><span class="p">,</span> <span class="n">cue_inp</span><span class="p">:</span> <span class="n">train_cues</span><span class="p">}</span>
    <span class="n">train_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">out</span><span class="p">:</span> <span class="n">train_targets</span><span class="p">}</span>

    <span class="c1"># train the model</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_inputs</span><span class="p">,</span> <span class="n">train_outputs</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">save_params</span><span class="p">(</span><span class="s1">&#39;./spa_retrieval_params&#39;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="c1"># download pretrained parameters</span>
    <span class="n">urlretrieve</span><span class="p">(</span>
        <span class="s2">&quot;https://drive.google.com/uc?export=download&amp;id=0B6DAasV-Fri4ZmJ1RWZtdVpYQTA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;spa_retrieval_params.zip&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s2">&quot;spa_retrieval_params.zip&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>

    <span class="c1"># load parameters</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">load_params</span><span class="p">(</span><span class="s1">&#39;./spa_retrieval_params&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can now recompute the network outputs using the trained model on the
test data. We can see that the retrieval accuracy is significantly
improved. You can modify the dimensionality of the vectors and the
number of bound pairs in each trace to explore how these variables
influence the upper bound on retrieval accuracy.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">input_feeds</span><span class="o">=</span><span class="n">test_inputs</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Retrieval accuracy: &#39;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">test_vocab</span><span class="p">,</span> <span class="n">test_targets</span><span class="p">))</span>
<span class="n">sim</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">bars</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_vocab</span><span class="o">.</span><span class="n">vectors</span><span class="p">)),</span>
               <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">test_vocab</span><span class="o">.</span><span class="n">vectors</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">out</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="n">bars</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">test_vocab</span><span class="o">.</span><span class="n">vectors</span> <span class="o">==</span> <span class="n">test_targets</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Vocabulary items&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Similarity&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Check out <a class="reference external" href="https://www.nengo.ai/nengo_dl/examples/spa_memory.html">this
example</a> for
a more complicated version of this task/model, in which a structured
semantic pointer is built up over time by binding together sequentially
presented input items.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="spa_memory.html" class="btn btn-neutral float-right" title="Optimizing a structured semantic pointer model with temporal dynamics" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../examples.html" class="btn btn-neutral" title="Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Applied Brain Research.
      Last updated on Jun 14, 2018.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  <!-- adapted from sphinx_rtd_theme versions.html -->

<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Versions</span>
        v0.6.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            
            
                <dd><a href="../../examples/spa_retrieval.html">latest</a></dd>
            

            
                
                    <dd><a href="../../v1.0.0/examples/spa_retrieval.html">v1.0.0</a></dd>
                
            
                
                    <dd><a href="../../v0.6.2/examples/spa_retrieval.html">v0.6.2</a></dd>
                
            
                
                    <dd><a href="../../v0.6.1/examples/spa_retrieval.html">v0.6.1</a></dd>
                
            
                
                    <dd>v0.6.0</dd>
                
            
                
                    <dd><a href="../../v0.5.2/examples/spa_retrieval.html">v0.5.2</a></dd>
                
            
                
                    <dd><a href="../../v0.5.1/examples/spa_retrieval.html">v0.5.1</a></dd>
                
            
                
                    <dd><a href="../../v0.5.0/examples/spa_retrieval.html">v0.5.0</a></dd>
                
            
                
                    <dd><a href="../../v0.4.0/examples/spa_retrieval.html">v0.4.0</a></dd>
                
            
                
                    <dd><a href="../../v0.3.1/examples/spa_retrieval.html">v0.3.1</a></dd>
                
            
                
                    <dd><a href="../../v0.3.0/examples/spa_retrieval.html">v0.3.0</a></dd>
                
            
                
                    <dd><a href="../../v0.2.0/examples/spa_retrieval.html">v0.2.0</a></dd>
                
            
                
                    <dd><a href="../..//examples/spa_retrieval.html"></a></dd>
                
            
        </dl>
    </div>
</div>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.6.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>